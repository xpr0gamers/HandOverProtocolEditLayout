sap.ui.define(["./BaseController","sap/m/MessageBox"],function(e,t){"use strict";return e.extend("sap.Beutlhauser.HandOverProtocolEditLayout.controller.Main",{onInit:function(){this.getRouter().getRoute("RouteMainView").attachPatternMatched(function(){this.getView().getModel("handoverLayout").setDeferredGroups(["own-group"]);this.getView().setModel(new sap.ui.model.json.JSONModel({oConfig:{oSelectedObject:null,oSelectedProductLineItem:null,sUrlHandoverPdf:null}}))},this)},loadObjects:function(e){this.getView().setBusy(true);this.getView().getModel("handoverLayout").read("/RootItemSet",{urlParameters:{$expand:"CriteriaItemSet",$filter:"Prodh eq '"+e+"'"},success:function(e){const t=e.results.map(function(e){e.CriteriaItemSet=e.CriteriaItemSet.results.map(function(e){e.Level=1;return e});e.Level=0;return e});this.getView().getModel().setProperty("/oObjects",t);this.getView().setBusy(false)}.bind(this),error:function(){this.getView().setBusy(false);this.showErrorMessage()}.bind(this)})},onClickAddRootItem:function(){this.getView().byId("TreeTableObjects").setBusy(true);var e=this.getView().getModel().getProperty("/oObjects")||[];const t="Überschrift Neu "+e.length;const i=this.getView().getModel().getProperty("/oConfig/oSelectedProductLineItem/Prodh");this.getView().getModel("handoverLayout").create("/RootItemSet",{GroupLabel:t,Prodh:i},{success:function(i){this.getView().byId("handoverPdfViewer").invalidate();e=e.slice();e.push({Guid:i.Guid,GroupLabel:t,Level:0,CriteriaItemSet:[]});this.getView().getModel().setProperty("/oObjects",e);this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this),error:function(){this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this)})},onClickAddCriterium:function(){var e=this.getView().getModel().getProperty("/oObjects");const t=this.getView().getModel().getProperty("/oConfig/oSelectedObject").getObject();const i="Kriterium Neu "+t.CriteriaItemSet.length;this.getView().getModel("handoverLayout").create("/CriteriaItemSet",{RootItemGuid:t.Guid,Bezeichnung:i},{success:function(o){this.getView().byId("handoverPdfViewer").invalidate();t.CriteriaItemSet.push({Guid:o.Guid,RootItemGuid:t.Guid,Bezeichnung:i,Level:1});e=e.slice();this.getView().getModel().setProperty("/oObjects",e);this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this),error:function(){this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this)})},onClickDeleteLayout:function(){t.confirm("Layout sicher löschen?",{onClose:function(e){if(e!="OK"){return}this.getView().setBusy(true);const t=this.getView().getModel().getProperty("/oObjects");t.forEach(function(e){if(e.Guid){this.getView().getModel("handoverLayout").remove("/RootItemSet(Guid=guid'"+e.Guid+"')",{groupId:"own-group"})}}.bind(this));this.getView().getModel("handoverLayout").submitChanges({groupId:"own-group",success:function(){this.getView().byId("handoverPdfViewer").invalidate();this.getView().getModel().setProperty("/oObjects",[]);this.getView().setBusy(false)}.bind(this),error:function(){this.getView().setBusy(false)}.bind(this)});this.getView().getModel().setProperty("/oConfig/oSelectedObject",null)}.bind(this)})},onRowSelectionChangeObjects:function(e){const t=e.getParameter("rowContext");if(this.getView().byId("TreeTableObjects").getSelectedIndex()===-1){this.getView().getModel().setProperty("/oConfig/oSelectedObject",null)}else{this.getView().getModel().setProperty("/oConfig/oSelectedObject",t)}},isCriteriaAddVisibleFormatter(e){if(e){return e.getProperty("Level")===0}else{return false}},isCriteriaDeleteVisibleFormatter(e){if(e){return e.getProperty("Level")===1}else{return false}},isLayoutDeleteCopyVisibleFormatter:function(e){if(e&&e.length!=0){return true}else{return false}},onValueHelpRequested:function(e){const t=this.getOwnerComponent().runAsOwner(function(){return new sap.ui.view({viewName:"sap.Beutlhauser.HandOverProtocolEditLayout.view.SelectProductLineForMainDialog",type:sap.ui.core.mvc.ViewType.XML})});e.getSource().addDependent(t);t.getController().showDialog(function(e){this.getView().getModel().setProperty("/oConfig/oSelectedProductLineItem",e);const t=this.getView().getModel("handoverLayout").sServiceUrl;this.getView().getModel().setProperty("/oConfig/sUrlHandoverPdf",t+"/HandOverPdfSet('"+e.Prodh+"')/$value");this.loadObjects(e.Prodh)}.bind(this))},onClickCopyLayout:function(e){const t=this.getOwnerComponent().runAsOwner(function(){return new sap.ui.view({viewName:"sap.Beutlhauser.HandOverProtocolEditLayout.view.CopyLayoutDialog",type:sap.ui.core.mvc.ViewType.XML})});e.getSource().addDependent(t);const i=this.getView().getModel().getProperty("/oConfig/oSelectedProductLineItem/Prodh");t.getController().showDialog(i)},onClickCopyHeadline:function(e){const t=this.getOwnerComponent().runAsOwner(function(){return new sap.ui.view({viewName:"sap.Beutlhauser.HandOverProtocolEditLayout.view.CopyHeadlineDialog",type:sap.ui.core.mvc.ViewType.XML})});e.getSource().addDependent(t);const i=this.getView().getModel().getProperty("/oConfig/oSelectedObject").getObject();t.getController().showDialog(i)},onClickDeleteCriteria:function(){const e=this.getView().getModel().getProperty("/oConfig/oSelectedObject");const i=this.getView().getModel("handoverLayout").createKey("/CriteriaItemSet",{Guid:e.getObject().Guid});t.confirm("Kriterium sicher löschen?",{onClose:function(t){if(t!="OK"){return}this.getView().byId("TreeTableObjects").setBusy(true);this.getView().getModel("handoverLayout").remove(i,{success:function(){this.getView().byId("handoverPdfViewer").invalidate();const t=this.getView().getModel().getProperty("/oObjects");const i=t.find(function(t){return t.CriteriaItemSet.indexOf(e.getObject())!=-1});const o=i.CriteriaItemSet.indexOf(e.getObject());i.CriteriaItemSet.splice(o,1);this.getView().getModel().setProperty("/oObjects",t);this.getView().getModel().setProperty("/oConfig/oSelectedObject",null);this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this),error:function(){this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this)})}.bind(this)})},onClickDeleteHeadline:function(){var e=this.getView().getModel().getProperty("/oObjects");const i=this.getView().getModel().getProperty("/oConfig/oSelectedObject");const o=i.getObject();const s=e.indexOf(o);t.confirm("Überschrift sicher löschen?",{onClose:function(t){if(t!="OK"){return}this.getView().byId("TreeTableObjects").setBusy(true);this.getView().getModel("handoverLayout").remove("/RootItemSet(Guid=guid'"+o.Guid+"')",{success:function(){this.getView().byId("handoverPdfViewer").invalidate();e=e.slice();e.splice(s,1);this.getView().getModel().setProperty("/oObjects",e);this.getView().getModel().setProperty("/oConfig/oSelectedObject",null);this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this),error:function(){this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this)})}.bind(this)})},onSelectCriteriaChange:function(e){const t=e.getSource().getBindingContext().getObject();this.changeCriteria(t)},onChangeGroupLabelRootItem:function(e){this.getView().byId("TreeTableObjects").setBusy(true);const t=e.getSource().getBindingContext().getObject();const i=this.getView().getModel("handoverLayout").createKey("/RootItemSet",{Guid:t.Guid});const o={GroupLabel:t.GroupLabel,Prodh:t.Prodh};this.getView().getModel("handoverLayout").update(i,o,{success:function(){this.getView().byId("handoverPdfViewer").invalidate();this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this),error:function(){this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this)})},onChangeBezeichnungCriteria:function(e){this.changeCriteria(e.getSource().getBindingContext().getObject())},changeCriteria:function(e){this.getView().byId("TreeTableObjects").setBusy(true);const t=this.getView().getModel("handoverLayout").createKey("/CriteriaItemSet",{Guid:e.Guid});const i={Criteria:e.Criteria,Bezeichnung:e.Bezeichnung,CountImages:e.CountImages};this.getView().getModel("handoverLayout").update(t,i,{success:function(){this.getView().byId("handoverPdfViewer").invalidate();this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this),error:function(){this.getView().byId("TreeTableObjects").setBusy(false)}.bind(this)})}})});